box: node
build:
   # The steps that will be executed on build
  steps:
      # A step that executes `npm install` command
      - npm-install
deploy:
  steps:
    - npm-install
    - script:
        name: install supervisor
        code: npm install -g supervisor
    - internal/docker-push:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        repository: jarellano01/ja-api
        ports: "8080"
        cmd: /bin/bash -c “cd /pipeline/source && supervisor - watch ./src src/server.js”
    - add-ssh-key:
        keyname: DIGITAL_OCEAN
    - add-to-known_hosts:
        hostname: 162.243.73.200
    - script:
        name: login
        code: ssh root@162.243.73.200 docker login
    - script:
        name: pull latest image
        code: ssh root@162.243.73.200 docker login --username 'jarellano01' --password 'Jon2310;'
    - script:
        name: stop running container
        code: ssh root@162.243.73.200 docker stop ja-api || echo ‘failed to stop running container’
    - script:
        name: remove stopped container
        code: ssh root@162.243.73.200 docker rm ja-api || echo ‘failed to remove stopped container’
    - script:
        name: remove image behind stopped container
        code: ssh root@162.243.73.200 docker rmi jarellano01/ja-api:current || echo ‘failed to remove image behind stopped container’
    - script:
        name: tag newly pulled image
        code: ssh root@162.243.73.200 docker tag jarellano01/ja-api:latest jarellano01/ja-api:current
    - script:
        name: run new container
        code: ssh root@162.243.73.200 docker run -d -p 8080:8080 --name ja-api jarellano01/ja-api:current